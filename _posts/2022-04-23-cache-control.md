---
title: HTTP Cache로 불필요한 네트워크 요청 방지하기
categories: TIL
tags: [TIL, HTTP]
excerpt: 네트워크 요청을 최적화하기 위한 HTTP 캐시 처리 방법을 알아보자!
---

네트워크를 통해 리소스를 가져오는 것은 느리고 비용이 많이 들기 때문에 불필요한 네트워크를 최대한 방지해야 한다.  
이를 해결할 수 있는 방법 중 하나가 바로 `HTTP Cache`이다.

# HTTP Cache

웹 브라우저가 서버에서 지금까지 요청한 적이 없는 리소스를 가져오려고 할 때, 서버와 브라우저는 완전한 HTTP 요청/응답을 주고받고, 이후에는 HTTP 요청 헤더와 응답 헤더에 포함된 캐시 설정에 따라 캐싱된 데이터를 전달할지, 리소스를 새로 받아올지 결정된다.

# 응답 헤더에서 캐싱 설정

응답 헤더에서 설정할 수 있는 캐싱 설정의 종류는 다음과 같다.

- `Cache-Control` : 캐시의 수명을 결정할 수 있다.
- `ETag` : 컨텐츠가 변경되었는지를 검사하는 태그.
  같은 주소의 자원이라도 컨텐츠가 달라졌으면 ETag가 다름.
  서버는 서버 컨텐츠(response body)가 달라졌음을 ETag를 보고 확인하여 캐시를 지우고 새로 컨텐츠를 내려 받는다.
- `Last-Modified` : 리소스가 변경되었는지 여부를 판단한다.

ETag와 Last-Modified 값은 기존에 받았던 리소스의 응답 헤더에 있는 값을 사용한다.

# Cache-Control

캐시된 문서의 만료 시간이 가까워져오면, 문서가 검증되거나 다시 불러와지게 된다.

## Cache-Control 값 종류

- `max-age` : 초 단위로 캐시의 신선도(수명)을 결정한다. `60\*60 = 3600`을 입력하면 1시간 동안 캐시가 유지된다. 그 이후에는 서버에 요청한 뒤 304 응답을 받을 때에만 캐시를 이용한다.
- `s-maxage`: 프록시 캐시(CDN 캐싱)에 대해서만 max-age 지시문을 재정의하고, 콘텐츠를 캐시할 수 있는 시간을 초 단위로 CDN에 전달한다. 지정된 시간이 만료되면 CDN은 원본 서버에서 콘텐츠를 다시 검증해야 한다.
- `no-cache` : 캐시가 유효한지 확인하기 위해 매번 서버에 유효성 검증을 요청해야 한다.
- `no-store` : 어떤 응답도 캐시로 저장하지 않는다. 데이터에 민감한 정보가 있을 때 사용한다.
- `private`: 브라우저는 파일을 캐시할 수 있지만 중간 캐시는 캐시할 수 없다.(타인과 공유되는 프록시 서버에는 캐시를 저장하지 않는다.) 기본적으로 Cache-Control은 private로 설정된다.
- `public`: 모든 응답을 캐시로 저장한다.

  > \* 웹 브라우저나 로컬에 저장되는 캐시는 private 캐시라 부르고 원서버와 브라우저 사이의 프록시 캐시 서버에서 사용하는 캐시는 public 캐시라고 부른다.

- **must-revalidate**: 캐시가 만료되었다면 반드시 원 서버에 검증 요청을 보내야 한다는 것을 의미한다. 만료된 HTTP 응답을 받아들이도록 설정이 되어 있는 캐시일지라도 마찬가지로 적용된다.
  - 만일 어떤 컨텐츠가 공유 캐시로 설정되어 있다면 프록시 서버단에서 캐시를 돌려줄 수 있기때문에 이를 방지하기 위한 정책이다.
  - 원서버에 접근할 수 없는 경우에는 반드시 오류가 발생해야 한다
  - 금융 데이터 등에 사용된다

## 완벽한 캐시 무효화 방법

완벽하게 캐시를 무효화하기 위해서는 아래와 같이 Cache-Control 값을 설정할 수 있다.

```
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
```

\* `Pragma` 헤더는 HTTP/1.1의 Cache-Control 헤더가 생기기 전에 동일한 역할로 사용되던 헤더이다.
`Pragma: no-cache`는 `Cache-Control: no-cache`와 동일하며, HTTP/1.0을 고려하지 않는다면 생략해도 된다.
(비슷하게 Expires도 HTTP/1.0이며, 대응되는 Cache-Control은 `max-age`이다. 함께 사용 시 Expires는 무시된다.)

# 재검증 요청 (요청 헤더)

캐시의 유효 기간이 지나면 캐시는 완전히 사라지는 것이 아니고, 브라우저는 서버에 캐시가 유효한지 **재검증(Revalidation)**을 요청하는 조건부 요청(Conditional request)을 수행한다.
대표적인 재검증 요청 헤더들은 다음과 같다.

- `If-None-Match` : 캐시된 리소스의 ETag 값과 현재 서버 리소스의 ETag 값이 같은지 확인하여 다를 경우에만 새로운 리소스를 가져온다.
- `If-Modified-Since`: 캐시된 리소스의 Last-Modified 값 이후에 서버 리소스가 수정되었는지 확인한다.

> 📖 참고
>
> - [웹 서비스 캐시 똑똑하게 다루기](https://toss.tech/article/jscodeshift)
> - [HTTP Cache로 불필요한 네트워크 요청 방지](https://web.dev/i18n/ko/http-cache/)
> - [mdn web docs](https://developer.mozilla.org/ko/docs/Web/HTTP/Caching)
